# OpenAFS Buildbot Configuration

## Introduction

This repository contains the Ansible playbook, configuration, and customization for
the [OpenAFS Buildbot Coordinator][2].

The `openafs_buildbot.yaml` playbook updates the buildbot coordinator.  This
playbook imports the `buildbot_master` role from the OpenAFS [Buildbot
Collection][4] to install and configure the buildbot coordinator.

The buildbot configuration is located in the YAML files under the `inventory`
directory.  User and worker passwords are encrypted with `ansible-vault`.  The
buildbot `master.cfg` file is generated by Ansible from the `master.cfg.j2`
template file.

Buildbot customization code is located in the `src/afsbotcfg` directory. The
playbook creates the `afsbotcfg` Python package from these source files and
installs the `afsbotcfg` package on the buildbot.

Development and local testing is supported with Ansible Molecule.  You will
need a virtualization provider supported by Molecule (such as Vagrant) to run
the Molecule tests.  SSH to the buildbot nor the vault key are required to
run the Molecule tests (except for the master-with-vault scenario).

## Setup

Before running the playbook or the molecule tests, create a Python virtualenv
and install the required Ansible and Molecule package versions in the
virtualenv.  The `setup` make target is provided to create the virtual
environment and install Ansible and Molecule packages in it.  The buildbot is
not installed on your controller.

    $ make setup

The molecule scenarios are setup to use Vagrant by default.  If you are using a
different virtualization provider, update the file `molecule.json` with the
required Molecule driver settings and then run `make setup` again to update
your project directory.

If you already have `molecule.json` file outside your project directory you
wish to use, set the `AFSBOTCFG_MOLECULE_JSON` environment variable to the path
of your `molecule.json` file and run `make clean` and the `make setup` to
update your project.

    $ export AFSBOTCFG_MOLECULE_JSON=$HOME/my-molecule-driver-config.json
    $ make clean
    $ make setup

See the `molecule.json.sample` for a sample molecule driver configuration file.

## Running the playbook

Before running the playbook, you should run `make test` to do a local test with
molecule.  (This requires the Ansible vault key by default.)

    $ make test

Run `make play` to run the Ansible playbook. This requires SSH access to the
buildbot server and the Ansible vault key.

    $ make play


## Development

Ansible Molecule scenarios are provided to run tests locally for testing and
development.  SSH access to the Buildbot server is not required to run the
molecule tests. Except for the `master-with-vault` scenario, the vault key is
not required to run the tests.

Activate the Python virtualenv and run molecule as usual.

    $ source .venv/bin/activate
    $ molecule list  # show available scenarios
    $ molecule create -s <scenario-name>
    $ molecule converge -s <scenario-name>
    $ molecule verify -s <scenario-name>
    $ molecule destroy -s <scenario-name>


[1]: https://www.openafs.org/
[2]: https://buildbot.openafs.org/
[4]: https://galaxy.ansible.com/openafs_contrib/buildbot
