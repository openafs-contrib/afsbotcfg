---
dependency:
  name: galaxy
  enabled: yes
  requirements-file: collections.yml

driver:
  name: {{ molecule.driver.name }}
{%- if molecule.driver.options is defined and molecule.driver.options %}
  options:
  {%- for name, value in molecule.driver.options.items() %}
    {{ name }}: {{ value }}
  {%- endfor %}
{%- endif %}

platforms:
  - name: afsbotcfg-master
{%- for name, value in molecule.platforms.centos7.items() %}
    {{ name }}: {{ value }}
{%- endfor %}
    groups:
      - openafs_buildbot_masters

  - name: afsbotcfg-alma-worker
{%- for name, value in molecule.platforms.alma9.items() %}
    {{ name }}: {{ value }}
{%- endfor %}
    groups:
      - openafs_buildbot_workers

  - name: afsbotcfg-debian-worker
{%- for name, value in molecule.platforms.debian11.items() %}
    {{ name }}: {{ value }}
{%- endfor %}
    groups:
      - openafs_buildbot_workers

  - name: afsbotcfg-ubuntu-worker
{%- for name, value in molecule.platforms.ubuntu20.items() %}
    {{ name }}: {{ value }}
{%- endfor %}
    groups:
      - openafs_buildbot_workers

provisioner:
  name: ansible
  env:
    ANSIBLE_VERBOSITY: 0
    ANSIBLE_STDOUT_CALLBACK: yaml
  inventory:
    host_vars:
      afsbotcfg-alma-worker:
        worker_name: "alma9-amd64"
      afsbotcfg-debian-worker:
        worker_name: "debian11-amd64"
      afsbotcfg-ubuntu-worker:
        worker_name: "ubuntu20-amd64"

    group_vars:
      all:
        afsbotcfg_project:
          name: "openafs"
          title: "OpenAFS Buildbot"
          summary_title: "The OpenAFS Buildbot Coordinator"
          db_url: "sqlite:///state.sqlite"
          url: "https://buildbot.openafs.org/"
          www_port: 8011
          pb_port: 9989
          email_from: "buildbot@openafs.MIT.EDU"
          repo: "git://gerrit.openafs.org/openafs.git"
          start_delay: 30
          branches:
            dev: "master"
            stable: "openafs-stable-1_8_x"
          oldstable: "openafs-stable-1_6_x"
          janitor:
            log_horizon: 4
            day_of_week: 6
            hour: 12

        afsbotcfg_admin_passwords:
          - ["admin@example.com", "secret"]

        afsbotcfg_worker_passwords:
          alma9-amd64: "secret"
          debian11-amd64: "secret"
          ubuntu20-amd64: "secret"

        afsbotcfg_workers:
          alma9-amd64:
            notify: "admin@example.com"
          debian11-amd64:
            notify: "admin@example.com"
          ubuntu20-amd64:
            notify: "admin@example.com"

        afsbotcfg_builders:
          - name: test-alma9-amd64
            scheduler: nightly
            branch: dev
            worker: alma9-amd64
            factory:
              name: UnixBuild

          - name: test-debian11-amd64
            scheduler: nightly
            branch: dev
            worker: debian11-amd64
            factory:
              name: UnixBuild
              args:
                configure: >-
                  --enable-transarc-paths --enable-checking
                target: dest
              env:
                CFLAGS: >-
                  -Wno-error=format-truncation -Wno-error=format-overflow -Wno-error=restrict
                  -Wno-error=array-bounds -Wno-error=implicit-function-declaration

          - name: test-ubuntu20-amd64
            scheduler: nightly
            branch: dev
            worker: ubuntu20-amd64
            factory:
              name: UnixBuildAndTest

verifier:
  name: ansible
